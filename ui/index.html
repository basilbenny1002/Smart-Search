<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search Bar</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html {
            background: transparent;
            overflow: hidden;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: transparent;
            overflow: hidden;
            margin: 0;
            padding: 0;
            transform: translateZ(0);
            backface-visibility: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* Drag handle – only this tiny area is draggable */
        .drag-handle {
            -webkit-app-region: drag;
            cursor: move;
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 30px;
            z-index: 1000;
            pointer-events: none;
        }
        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: transparent;
            padding: 0;
            margin: 0;
            -webkit-app-region: no-drag;
        }

        /* All interactive elements */
        input, button, .results, .result-item, .action-button, .grid-view {
            -webkit-app-region: no-drag;
            pointer-events: auto;
        }

        .extended-area {
            -webkit-app-region: no-drag;
            padding: 8px 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-shrink: 0;
            background: transparent;
            position: relative;
            z-index: 1;
        }
        .hint-text {
            font-size: 16px;
            color: rgba(55, 55, 97, 0.6);
            font-style: italic;
        }
        .bottom-buttons {
            display: flex;
            gap: 8px;
            position: fixed;
            bottom: 12px;
            right: 12px;
            z-index: 1000;
        }
        .bottom-buttons.hidden { display: none; }

        .loading-indicator {
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 11px;
            color: rgba(100,100,150,0.7);
            font-style: italic;
        }
        .loading-indicator.show { display: flex; }
        .spinner {
            width: 16px; height: 16px;
            border: 2px solid rgba(100,150,200,0.3);
            border-top-color: rgba(100,150,200,0.9);
            border-radius: 50%;
            animation: spin .8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .icon-button {
            background: linear-gradient(135deg,rgba(100,150,200,0.7),rgba(150,120,200,0.7));
            border:none; border-radius:6px; padding:6px 12px;
            color:#fff; font-size:11px; font-weight:600;
            cursor:pointer; transition:all .2s ease;
            display:flex; align-items:center; gap:4px;
        }
        .icon-button:hover { background:linear-gradient(135deg,rgba(100,150,200,0.9),rgba(150,120,200,0.9)); transform:translateY(-1px); }
        .icon-button:active { transform:translateY(0); }
        .icon-button svg { width:14px; height:14px; stroke:#fff; stroke-width:2; fill:none; }

        .search-wrapper { -webkit-app-region:no-drag; padding:12px; flex-shrink:0; background:transparent; position:relative; z-index:2000; }
        .search-bar {
            display:flex; align-items:center; gap:8px;
            padding:10px 16px;
            background:linear-gradient(135deg,rgba(173,216,230,0.6),rgba(216,191,216,0.6));
            border:1px solid rgba(255,255,255,.3);
            border-radius:28px;
            box-shadow:0 8px 32px rgba(31,38,135,.15);
            backdrop-filter:blur(4px);
            transition:all .3s ease;
        }
        .search-bar:focus-within {
            box-shadow:0 8px 32px rgba(31,38,135,.25);
            background:linear-gradient(135deg,rgba(173,216,230,0.8),rgba(216,191,216,0.8));
        }
        .search-icon { flex-shrink:0; width:24px; height:24px; display:flex; align-items:center; justify-content:center; }
        .search-icon svg { width:22px; height:22px; stroke:rgba(80,80,130,.9); stroke-width:2; fill:none; }
        #searchInput {
            flex:1; border:none; background:transparent; outline:none;
            font-size:14px; color:rgba(50,50,80,.9); padding:4px 0;
        }
        #searchInput::placeholder { color:rgba(100,100,150,.5); }

        .search-button {
            -webkit-app-region:no-drag;
            background:linear-gradient(135deg,rgba(100,150,200,0.7),rgba(150,120,200,0.7));
            border:none; border-radius:20px; padding:6px 14px;
            color:#fff; font-size:12px; font-weight:600;
            cursor:pointer; transition:all .2s ease; flex-shrink:0;
        }
        .search-button:hover { background:linear-gradient(135deg,rgba(100,150,200,0.9),rgba(150,120,200,0.9)); transform:scale(1.05); }
        .search-button:active { transform:scale(.95); }

        .filter-group { display:flex; gap:6px; align-items:center; }
        .filter-btn {
            border:none; background:transparent; cursor:pointer;
            width:28px; height:28px; display:flex; align-items:center; justify-content:center;
            opacity:.6; transition:all .2s ease; border-radius:6px;
        }
        .filter-btn:hover { opacity:.9; background:rgba(255,255,255,.2); }
        .filter-btn[style*="opacity: 1"] { opacity:1; background:rgba(255,255,255,.3); }
        .filter-btn svg { width:16px; height:16px; stroke:rgba(100,100,150,.8); stroke-width:1.5; fill:rgba(100,100,150,.1); }

        .search-controls { display:flex; gap:4px; align-items:center; position:relative; }
        .dropdown-toggle {
            -webkit-app-region:no-drag;
            background:linear-gradient(135deg,rgba(100,150,200,0.7),rgba(150,120,200,0.7));
            border:none; border-radius:20px; padding:6px 10px;
            color:#fff; font-size:12px; cursor:pointer;
            transition:all .2s ease; flex-shrink:0;
            display:flex; align-items:center; justify-content:center;
        }
        .dropdown-toggle:hover { background:linear-gradient(135deg,rgba(100,150,200,0.9),rgba(150,120,200,0.9)); }
        .dropdown-toggle svg { width:14px; height:14px; stroke:#fff; stroke-width:2; fill:none; }

        /* -------------------------------------------------
           DROPDOWN MENU – fully interactive in frameless window
           ------------------------------------------------- */
        .dropdown-menu {
            position:absolute; top:100%; right:0;
            background:rgba(255,255,255,.95);
            border-radius:12px;
            box-shadow:0 8px 24px rgba(0,0,0,.15);
            margin-top:8px; min-width:220px;
            display:none; z-index:2001;
            overflow:hidden;
            -webkit-app-region:no-drag;      /* <-- critical */
            pointer-events:auto;            /* <-- critical */
        }
        .dropdown-menu.show { display:block; }

        .dropdown-item {
            padding:12px 16px; cursor:pointer;
            transition:all .2s ease;
            border-bottom:1px solid rgba(0,0,0,.05);
            display:flex; flex-direction:column; gap:4px;
            -webkit-app-region:no-drag;
            pointer-events:auto;
            width:100%;
        }
        .dropdown-item:last-child { border-bottom:none; }
        .dropdown-item:hover { background:rgba(100,150,200,.1); }
        .dropdown-item.active {
            background:rgba(100,150,200,.2);
            border-left:3px solid rgba(100,150,200,1);
            padding-left:13px;
        }
        .dropdown-item-title {
            font-weight:600; color:rgba(30,30,60,.95);
            font-size:12px;
            -webkit-app-region:no-drag;
            pointer-events:none;
        }
        .dropdown-item-desc {
            font-size:11px; color:rgba(100,100,140,.7);
            -webkit-app-region:no-drag;
            pointer-events:none;
        }

        .results-container {
            -webkit-app-region:no-drag;
            flex:1; overflow-y:hidden; padding:8px 12px;
            display:none; height:100%; min-height:0;
        }
        .results-container.show { display:block; overflow-y:auto; scroll-behavior:smooth; -webkit-overflow-scrolling:touch; }
        .results-container.grid-view {
            display:grid !important;
            grid-template-columns:repeat(3,1fr);
            gap:16px; padding:16px;
            overflow-y:auto !important;
            height:100%; scroll-behavior:smooth;
            -webkit-overflow-scrolling:touch;
        }

        .result-item {
            display:flex; align-items:center; gap:12px;
            padding:10px 12px; margin-bottom:6px;
            background:rgba(255,255,255,.85);
            border-radius:8px; cursor:pointer;
            transition:all .2s ease;
            border-left:3px solid transparent;
            box-shadow:0 2px 8px rgba(0,0,0,.08);
        }
        .result-item:hover { background:rgba(255,255,255,.95); border-left-color:rgba(150,120,200,.8); box-shadow:0 4px 12px rgba(0,0,0,.12); }
        .result-item.selected { background:rgba(100,120,180,.9); border-left-color:rgba(200,220,255,1); box-shadow:0 4px 12px rgba(100,120,180,.4); }
        .result-item.selected .result-name { color:rgba(255,255,255,.95); }
        .result-item.selected .result-path { color:rgba(200,220,255,.85); }
        .result-item.selected .result-type-badge { color:rgba(200,220,255,.9); background:rgba(200,220,255,.2); }
        .result-item.selected .result-icon svg { stroke:rgba(200,220,255,.9); fill:rgba(200,220,255,.15); }

        .result-image-preview { flex-shrink:0; width:40px; height:40px; border-radius:6px; object-fit:cover; background:rgba(0,0,0,.05); }

        .image-card { display:flex; flex-direction:column; background:rgba(255,255,255,.9); border-radius:12px; overflow:hidden; transition:all .3s ease; box-shadow:0 2px 8px rgba(0,0,0,.1); height:300px; min-height:300px; max-height:300px; }
        .image-card:hover { transform:translateY(-4px); box-shadow:0 8px 24px rgba(0,0,0,.15); background:rgba(255,255,255,1); }
        .image-card.selected { box-shadow:0 8px 24px rgba(100,120,180,.4); transform:translateY(-4px); border:2px solid rgba(150,120,200,.8); }
        .image-card-preview { width:100%; height:200px; object-fit:contain; background:linear-gradient(135deg,rgba(240,240,245,.8),rgba(230,230,240,.8)); cursor:pointer; display:block; }
        .image-card-info { padding:12px; display:flex; flex-direction:column; gap:4px; }
        .image-card-name { font-size:13px; font-weight:500; color:rgba(30,30,60,.95); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .image-card-path { font-size:11px; color:rgba(100,100,140,.75); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .image-card-actions { display:flex; gap:8px; margin-top:8px; }
        .image-action-btn { flex:1; padding:6px 12px; font-size:11px; font-weight:500; border:none; border-radius:6px; cursor:pointer; transition:all .2s ease; display:flex; align-items:center; justify-content:center; gap:4px; }
        .image-action-btn.open { background:rgba(100,120,180,.9); color:#fff; }
        .image-action-btn.open:hover { background:rgba(100,120,180,1); transform:scale(1.02); }
        .image-action-btn.locate { background:rgba(150,120,200,.15); color:rgba(100,120,180,.9); }
        .image-action-btn.locate:hover { background:rgba(150,120,200,.25); transform:scale(1.02); }

        .result-info { flex:1; min-width:0; }
        .result-name { font-size:13px; font-weight:500; color:rgba(30,30,60,.95); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .result-path { font-size:11px; color:rgba(100,100,140,.75); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-top:2px; }
        .no-results { text-align:center; padding:20px; color:rgba(100,100,150,.6); font-size:13px; }

        .results-container::-webkit-scrollbar { width:6px; }
        .results-container::-webkit-scrollbar-track { background:transparent; }
        .results-container::-webkit-scrollbar-thumb { background:rgba(150,120,200,.4); border-radius:3px; }
        .results-container::-webkit-scrollbar-thumb:hover { background:rgba(150,120,200,.6); }

        .result-type-badge {
            margin-left:8px; font-size:10px; font-weight:600;
            color:rgba(100,120,180,.8); background:rgba(100,120,180,.1);
            border-radius:10px; padding:3px 8px; letter-spacing:.5px;
        }
    </style>
</head>
<body>
    <div class="drag-handle"></div>

    <div class="container">
        <div class="search-wrapper">
            <div class="search-bar">
                <span class="search-icon" id="searchIconContainer"></span>
                <input type="text" id="searchInput" placeholder="Search files, folders, images..." autocomplete="off">
                <div class="filter-group">
                    <button class="filter-btn" data-filter="all" title="All" aria-label="All"></button>
                    <button class="filter-btn" data-filter="folder" title="Folders" aria-label="Folders"></button>
                    <button class="filter-btn" data-filter="image" title="Images" aria-label="Images"></button>
                    <button class="filter-btn" data-filter="video" title="Videos" aria-label="Videos"></button>
                    <button class="filter-btn" data-filter="doc" title="Documents" aria-label="Documents"></button>
                    <button class="filter-btn" data-filter="other" title="Others" aria-label="Others"></button>
                </div>
                <div class="search-controls">
                    <button class="search-button" id="searchBtn">Search</button>
                    <button class="dropdown-toggle" id="dropdownToggle">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><polyline points="6 9 12 15 18 9"/></svg>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <div class="dropdown-item active" data-search-type="normal" id="modeNormal">
                            <div class="dropdown-item-title">Normal</div>
                            <div class="dropdown-item-desc">Search by file/folder names</div>
                        </div>
                        <div class="dropdown-item" data-search-type="text" id="modeText">
                            <div class="dropdown-item-title">Text Search</div>
                            <div class="dropdown-item-desc">Search file contents</div>
                        </div>
                        <div class="dropdown-item" data-search-type="image" id="modeImage">
                            <div class="dropdown-item-title">Image Search</div>
                            <div class="dropdown-item-desc">Search by image description</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="extended-area">
            <span class="hint-text" id="hintText">Start typing to search...</span>
            <div class="loading-indicator" id="loadingIndicator">
                <div class="spinner"></div><span>Searching...</span>
            </div>
            <div class="bottom-buttons" id="bottomButtons">
                <button class="icon-button" id="infoBtn" title="Information">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
                    Info
                </button>
                <button class="icon-button" id="settingsBtn" title="Settings">
                    <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v10M1 12h6m6 0h10"/></svg>
                    Settings
                </button>
            </div>
        </div>

        <div class="results-container" id="resultsContainer"></div>
    </div>

    <script>
        /* ---------- SVG icons ---------- */
        function getSvgIcon(type) {
            const icons = {
                search: '<svg viewBox="0 0 24 24"><circle cx="10" cy="10" r="6"/><path d="M14 14l6 6"/></svg>',
                folder: '<svg viewBox="0 0 24 24"><path d="M3 6h8l2 2h8a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2z"/></svg>',
                image: '<svg viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M3 15l6-6 9 9"/></svg>',
                video: '<svg viewBox="0 0 24 24"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M10 9l5 3-5 3V9z"/></svg>',
                document: '<svg viewBox="0 0 24 24"><path d="M13 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>',
                audio: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5h4V7h2v5h4l-5 5z"/></svg>',
                archive: '<svg viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-1 9h-5v5h-2v-5H7v-2h5V8h2v5h5v2z"/></svg>',
                file: '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>',
                all: '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg>',
                other: '<svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z"/></svg>'
            };
            return icons[type] || icons.file;
        }

        function iconForType(type) {
            const t = (type || '').toLowerCase();
            if (["png","jpg","jpeg","gif","bmp","webp","image"].includes(t)) return 'image';
            if (["mp4","mkv","mov","avi","video"].includes(t)) return 'video';
            if (["mp3","wav","flac","m4a","audio"].includes(t)) return 'audio';
            if (["zip","7z","rar","tar","gz"].includes(t)) return 'archive';
            if (["pdf","ppt","pptx","xls","xlsx","csv","md","txt","rtf","doc","docx"].includes(t)) return 'document';
            if (t === 'folder') return 'folder';
            return 'file';
        }

        /* ---------- State ---------- */
        let selectedIndex = -1;
        let currentResults = [];
        let activeFilter = 'all';
        let currentSearchType = 'normal';

        const searchInput        = document.getElementById('searchInput');
        const resultsContainer   = document.getElementById('resultsContainer');
        const searchButton       = document.getElementById('searchBtn');
        const searchIconContainer= document.getElementById('searchIconContainer');
        const dropdownToggle     = document.getElementById('dropdownToggle');
        const dropdownMenu       = document.getElementById('dropdownMenu');
        const hintText           = document.getElementById('hintText');
        const loadingIndicator   = document.getElementById('loadingIndicator');
        const bottomButtons      = document.getElementById('bottomButtons');

        searchIconContainer.innerHTML = getSvgIcon('search');

        /* ---------- Dropdown toggle ---------- */
        dropdownToggle.addEventListener('click', e => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
        });
        document.addEventListener('click', e => {
            if (dropdownMenu.classList.contains('show') &&
                !dropdownMenu.contains(e.target) &&
                !dropdownToggle.contains(e.target)) {
                dropdownMenu.classList.remove('show');
            }
        });

        /* ---------- Mode switching (click ANYWHERE in the row) ---------- */
        function setActiveDropdownItem(type) {
            dropdownMenu.querySelectorAll('.dropdown-item').forEach(i => i.classList.remove('active'));
            const map = { normal: 'modeNormal', text: 'modeText', image: 'modeImage' };
            const el = document.getElementById(map[type]);
            if (el) el.classList.add('active');
        }

        async function switchSearchMode(newType) {
            if (newType === currentSearchType) { dropdownMenu.classList.remove('show'); return; }
            setActiveDropdownItem(newType);
            if (newType === 'image' && currentSearchType !== 'image') await preloadImageEmbeddings();
            currentSearchType = newType;
            dropdownMenu.classList.remove('show');

            resultsContainer.classList.remove('grid-view','show');
            resultsContainer.innerHTML = '';
            currentResults = []; selectedIndex = -1;

            hintText.style.display = 'block';
            hintText.textContent = newType === 'image' ? 'Search images by description...' :
                                   newType === 'text'   ? 'Search file contents...' :
                                                          'Start typing to search...';

            const q = searchInput.value.trim();
            if (q) performSearch(q);
            else if (window.pywebview?.api?.resize_window) await window.pywebview.api.resize_window(false);
        }

        document.getElementById('modeNormal').addEventListener('click', () => switchSearchMode('normal'));
        document.getElementById('modeText')  .addEventListener('click', () => switchSearchMode('text'));
        document.getElementById('modeImage') .addEventListener('click', () => switchSearchMode('image'));

        /* ---------- Image-embedding preload ---------- */
        async function preloadImageEmbeddings() {
            try {
                hintText.style.display = 'block';
                hintText.textContent = 'Loading image embeddings...';
                loadingIndicator.classList.add('show');

                if (window.pywebview?.api?.check_embeddings_loaded) {
                    const status = await window.pywebview.api.check_embeddings_loaded();
                    if (!status.loaded && window.pywebview?.api?.preload_image_embeddings) {
                        const res = await window.pywebview.api.preload_image_embeddings();
                        hintText.textContent = res.status === 'success'
                            ? `Loaded ${res.count} images. Ready to search!`
                            : 'No images indexed yet. Please index images first.';
                    } else {
                        hintText.textContent = 'Image search ready!';
                    }
                }
                loadingIndicator.classList.remove('show');
                setTimeout(() => { if (!searchInput.value.trim()) hintText.textContent = 'Start typing to search...'; }, 2000);
            } catch (e) {
                console.error(e);
                loadingIndicator.classList.remove('show');
                hintText.textContent = 'Error loading embeddings. Try again.';
            }
        }

        /* ---------- Search ---------- */
        async function performSearch(query) {
            if (!query.trim()) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.remove('show');
                currentResults = []; selectedIndex = -1;
                hintText.style.display = 'block';
                hintText.textContent = 'Start typing to search...';
                loadingIndicator.classList.remove('show');
                bottomButtons.classList.remove('hidden');
                if (window.pywebview?.api?.resize_window) await window.pywebview.api.resize_window(false);
                return;
            }

            hintText.style.display = 'none';
            loadingIndicator.classList.add('show');
            bottomButtons.classList.add('hidden');

            let results = [];
            try {
                // Pass active filter to backend for normal search
                if (window.pywebview?.api?.search) {
                    if (currentSearchType === 'normal' && activeFilter !== 'all') {
                        // Map frontend filter names to backend categories
                        const filterMap = {
                            'folder': 'folder',
                            'image': 'image',
                            'video': 'video',
                            'doc': 'document',
                            'other': 'file'
                        };
                        const category = filterMap[activeFilter] || null;
                        results = await window.pywebview.api.search(query, currentSearchType, category);
                    } else {
                        results = await window.pywebview.api.search(query, currentSearchType);
                    }
                }
            } catch (e) { console.warn(e); }

            loadingIndicator.classList.remove('show');

            const normalized = (results || []).map(r => ({
                name: r.name || r.file_name || '',
                path: r.path || r.file_path || '',
                type: r.type || r.file_type || 'file',
                iconType: iconForType(r.type || r.file_type),
                image_url: r.image_url || r.thumbnail || null,
                snippet: r.snippet || null,
                score: r.score || 0
            }));

            // For normal search with category filter, results are already filtered by backend
            // For other search types or 'all' filter, apply client-side filtering
            let filtered;
            if (currentSearchType === 'normal' && activeFilter !== 'all') {
                // Backend already filtered, use results as-is
                filtered = normalized;
            } else {
                // Apply client-side filtering for image/text search or 'all' filter
                filtered = normalized.filter(item => {
                    if (activeFilter === 'all') return true;
                    const t = (item.type || '').toLowerCase();
                    if (activeFilter === 'folder') return t === 'folder';
                    if (activeFilter === 'image') return ['png','jpg','jpeg','gif','bmp','webp','image'].includes(t);
                    if (activeFilter === 'video') return ['mp4','mkv','mov','avi','video'].includes(t);
                    if (activeFilter === 'doc')   return ['pdf','ppt','pptx','xls','xlsx','csv','md','txt','rtf','doc','docx'].includes(t);
                    if (activeFilter === 'other') return !['png','jpg','jpeg','gif','bmp','webp','image','mp4','mkv','mov','avi','video','pdf','ppt','pptx','xls','xlsx','csv','md','txt','rtf','doc','docx','folder'].includes(t);
                    return true;
                });
            }

            currentResults = filtered; selectedIndex = -1;
            displayResults(filtered);
        }

        /* ---------- Render results ---------- */
        async function displayResults(results) {
            if (!results.length) {
                resultsContainer.innerHTML = '<div class="no-results">No results found</div>';
                resultsContainer.classList.add('show');
                resultsContainer.classList.remove('grid-view');
                hintText.style.display = 'none';
                if (window.pywebview?.api?.resize_window) await window.pywebview.api.resize_window(false);
                return;
            }

            hintText.style.display = 'none';
            if (window.pywebview?.api?.resize_window) await window.pywebview.api.resize_window(true);

            if (currentSearchType === 'image') {
                resultsContainer.classList.add('grid-view');
                resultsContainer.innerHTML = results.map((item,i) => `
                    <div class="image-card" data-index="${i}">
                        <img src="${escapeHtml(item.image_url)}" alt="${escapeHtml(item.name)}" class="image-card-preview">
                        <div class="image-card-info">
                            <div class="image-card-name" title="${escapeHtml(item.name)}">${escapeHtml(item.name)}</div>
                            <div class="image-card-path" title="${escapeHtml(item.path)}">${escapeHtml(item.path)}</div>
                            <div class="image-card-actions">
                                <button class="image-action-btn open" data-action="open" data-index="${i}">Open</button>
                                <button class="image-action-btn locate" data-action="locate" data-index="${i}">Locate</button>
                            </div>
                        </div>
                    </div>`).join('');

                document.querySelectorAll('.image-card').forEach(el => {
                    const idx = +el.dataset.index;
                    el.addEventListener('mouseover', () => { selectedIndex = idx; updateSelection(); });
                });
                document.querySelectorAll('.image-action-btn').forEach(btn => {
                    btn.addEventListener('click', e => {
                        e.stopPropagation();
                        const idx = +btn.dataset.index;
                        const act = btn.dataset.action;
                        if (act === 'open') openResult(currentResults[idx]);
                        else if (act === 'locate') openFileLocation(currentResults[idx]);
                    });
                });
            } else {
                resultsContainer.classList.remove('grid-view');
                resultsContainer.innerHTML = results.map((item,i) => `
                    <div class="result-item" data-index="${i}">
                        <span class="result-icon">${getSvgIcon(item.iconType)}</span>
                        <div class="result-info">
                            <div class="result-name">${escapeHtml(item.name)}</div>
                            <div class="result-path">${escapeHtml(item.path)}</div>
                            ${item.snippet ? `<div class="result-snippet" style="font-size:11px;color:rgba(50,50,80,.6);margin-top:3px;font-style:italic;">${escapeHtml(item.snippet)}</div>` : ''}
                        </div>
                        <span class="result-type-badge">${(item.type||'').toUpperCase()}</span>
                    </div>`).join('');

                document.querySelectorAll('.result-item').forEach(el => {
                    const idx = +el.dataset.index;
                    el.addEventListener('mouseover', () => { selectedIndex = idx; updateSelection(); });
                    el.addEventListener('click', () => {
                        selectedIndex = idx; updateSelection();
                        openResult(currentResults[idx]);
                    });
                });
            }
            resultsContainer.classList.add('show');
        }

        function updateSelection() {
            document.querySelectorAll('.result-item, .image-card').forEach((el,i) => el.classList.toggle('selected', i===selectedIndex));
            if (selectedIndex >= 0) document.querySelector(`[data-index="${selectedIndex}"]`)?.scrollIntoView({block:'nearest'});
        }

        function openResult(item) {
            if (window.pywebview?.api?.open_file) {
                window.pywebview.api.open_file(item.path, item.type).catch(console.error);
            } else {
                alert(`Would open: ${item.path}\nType: ${item.type}`);
            }
        }
        function openFileLocation(item) {
            if (window.pywebview?.api?.open_file_location) {
                window.pywebview.api.open_file_location(item.path).catch(console.error);
            } else {
                alert(`Would open location: ${item.path}`);
            }
        }

        /* ---------- Keyboard navigation ---------- */
        searchInput.addEventListener('keydown', e => {
            if (e.key === 'ArrowDown') { e.preventDefault(); if (currentResults.length) selectedIndex = Math.min(selectedIndex+1, currentResults.length-1); updateSelection(); }
            else if (e.key === 'ArrowUp')   { e.preventDefault(); if (currentResults.length) selectedIndex = Math.max(selectedIndex-1, 0); updateSelection(); }
            else if (e.key === 'Enter')     { e.preventDefault(); if (selectedIndex >= 0) openResult(currentResults[selectedIndex]); }
            else if (e.key === 'Escape') {
                searchInput.value = '';
                resultsContainer.classList.remove('show'); resultsContainer.innerHTML = '';
                currentResults = []; selectedIndex = -1;
                hintText.style.display = 'block'; hintText.textContent = 'Start typing to search...';
                loadingIndicator.classList.remove('show'); bottomButtons.classList.remove('hidden');
            }
        });

        /* ---------- Live search (debounced for non-normal modes) ---------- */
        let debounceId;
        searchInput.addEventListener('input', e => {
            const val = e.target.value;
            if (currentSearchType === 'normal') performSearch(val);
            else { clearTimeout(debounceId); debounceId = setTimeout(() => performSearch(val), 500); }
        });

        /* ---------- Filter buttons ---------- */
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.innerHTML = getSvgIcon(btn.dataset.filter);
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.style.opacity = '.6');
                btn.style.opacity = '1.0';
                activeFilter = btn.dataset.filter;
                performSearch(searchInput.value || '');
            });
        });
        document.querySelector('.filter-btn[data-filter="all"]').style.opacity = '1.0';

        /* ---------- Global shortcuts ---------- */
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') try { window.pywebview?.api?.toggle_window?.(); } catch{}
            if (e.ctrlKey && e.code === 'Space') { e.preventDefault(); try { window.pywebview?.api?.toggle_window?.(); } catch{} }
        });

        searchButton.addEventListener('click', () => selectedIndex >= 0 ? openResult(currentResults[selectedIndex]) : performSearch(searchInput.value));
        document.getElementById('settingsBtn').addEventListener('click', () => window.pywebview?.api?.open_settings?.());
        document.getElementById('infoBtn')    .addEventListener('click', () => window.pywebview?.api?.open_info?.());

        function escapeHtml(t) { const d=document.createElement('div'); d.textContent=t; return d.innerHTML; }

        window.addEventListener('load', () => searchInput.focus());
    </script>
</body>
</html>